<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Surmise Phase 4 Test</title>
  <style>
    body {
      padding: 40px;
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .test-section {
      margin-bottom: 32px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }

    .test-section h2 {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 12px;
      color: #666;
    }

    input {
      font-size: 16px;
      padding: 12px;
      width: 100%;
      border: 2px solid #ddd;
      border-radius: 6px;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border-color: #0066ff;
    }

    .info {
      margin-top: 12px;
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }

    .log {
      margin-top: 12px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 4px;
    }

    .log-entry.accept {
      color: #00aa00;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Phase 4: attachSurmise() Test</h1>

  <div class="test-section">
    <h2>Test 1: Basic Autocomplete</h2>
    <input id="test1" placeholder="Type 'thank you'..." />
    <div class="info">
      <strong>Instructions:</strong><br>
      • Type "thank you" → should suggest " for your email"<br>
      • Press <kbd>Tab</kbd> to accept<br>
      • Type "sounds" → should suggest " good"<br>
      • Press <kbd>→</kbd> (ArrowRight at end) to accept<br>
      • Press <kbd>Esc</kbd> to dismiss suggestion
    </div>
    <div id="log1" class="log"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Different Styling</h2>
    <input
      id="test2"
      placeholder="Larger font test..."
      style="font-size: 20px; padding: 16px; font-family: 'Georgia', serif;"
    />
    <div class="info">
      Type "looking forward" → should suggest " to hearing from you"
    </div>
  </div>

  <div class="test-section">
    <h2>Test 3: IME Composition (if you have Japanese/Chinese keyboard)</h2>
    <input id="test3" placeholder="Test IME..." />
    <div class="info">
      Ghost text should NOT appear during composition
    </div>
  </div>

  <script type="module">
    // Simple mock provider for testing
    const mockProvider = {
      id: 'test-provider',
      priority: 10,
      async suggest(ctx) {
        const text = ctx.text.toLowerCase()

        // Simple phrase matching
        const phrases = {
          'thank you': ' for your email',
          'sounds': ' good',
          'looking forward': ' to hearing from you',
          'best': ' regards',
          'talk': ' soon',
          'see you': ' later',
          'no': ' problem',
        }

        for (const [prefix, suffix] of Object.entries(phrases)) {
          if (text.endsWith(prefix)) {
            return {
              text: suffix,
              confidence: 90,
              providerId: 'test-provider'
            }
          }
        }

        return null
      }
    }

    // Helper to log events
    function createLogger(logId) {
      const logEl = document.getElementById(logId)
      return {
        log(message, isAccept = false) {
          const entry = document.createElement('div')
          entry.className = 'log-entry' + (isAccept ? ' accept' : '')
          entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
          logEl.appendChild(entry)
          logEl.scrollTop = logEl.scrollHeight
        }
      }
    }

    // Test setup helper
    async function setupTest(inputId, logId) {
      const { attachSurmise } = await import('./packages/core/dist/index.js')

      const input = document.getElementById(inputId)
      const logger = logId ? createLogger(logId) : null

      const detach = attachSurmise(input, {
        providers: [mockProvider],
        debounceMs: 150,
        onSuggestion: (suggestion) => {
          if (logger) {
            if (suggestion) {
              logger.log(`Suggestion: "${suggestion.text}" (${suggestion.confidence}% confidence)`)
            } else {
              logger.log('Suggestion cleared')
            }
          }
        },
        onAccept: (suggestion) => {
          if (logger) {
            logger.log(`✓ ACCEPTED: "${suggestion.text}"`, true)
          }
        }
      })

      return detach
    }

    // Initialize tests
    setupTest('test1', 'log1')
    setupTest('test2')
    setupTest('test3')

    console.log('Phase 4 tests initialized')
  </script>
</body>
</html>
